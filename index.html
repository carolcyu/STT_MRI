<!DOCTYPE html>
<html>
<head>
    <title>Welcome</title>
    <script src="./jspsych/jspsych.js"></script>
    <script src="./jspsych/plugin-image-keyboard-response.js"></script>
    <script src="./jspsych/plugin-html-keyboard-response.js"></script>
    <script src="./jspsych/plugin-html-button-response.js"></script>
    <link href="./jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="./jspsych/my_experiment_style_MRI.css">
    <script src="./jspsych/plugin-categorize-html.js"></script>
    <script src="./lib/taskflow/client.js"></script>
</head>
<body></body>
<script>
    /* initialize jsPsych */
    var jsPsych = initJsPsych({
        on_finish: async function() {
            if (window.location !== window.parent.location) {
                // running on server
                var measure = await TaskFlow.Client.Measure.get();
                var task_data = JSON.stringify(jsPsych.data.get().values());
                measure.complete = true;
                measure.json = task_data;
                await TaskFlow.Client.Measure.set(measure);
                TaskFlow.Client.Measure.end();
            } else {
                // running local
               jsPsych.data.get().localSave('json', 'STT_data_task1.json');
                jsPsych.data.displayData(); // Useful for local testing
            }
        }
    });

    var timeline = [];

    /* Welcome & Instructions */
    var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Welcome to the Image Rating Task!</p><p>Press any button for instructions.</p>",
        choices: "ALL_KEYS"
    };
    timeline.push(welcome);

    var instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>In this task, an image will appear on the screen.</p>
                   <p>Using the response pad, please rate <strong>HOW PLEASANT</strong> an image is.</p>
                   <p><strong>1</strong>: Very unpleasant | <strong>2</strong>: Unpleasant</p>
                   <p><strong>3</strong>: Pleasant | <strong>4</strong>: Very pleasant</p>
                   <p><img src="img/response_key.png" alt="Key" style="width:200px;"></p>
                   <p>Press any button to continue.</p>`,
        choices: "ALL_KEYS",
        post_trial_gap: 1000
    };
    timeline.push(instructions);

    /* Practice Trials */
    var practice_stimuli = [
        { stim: 'img/practice1.jpg', ans: '1', text: 'Very Unpleasant' },
        { stim: 'img/practice2.jpg', ans: '3', text: 'Pleasant' },
        { stim: 'img/practice3.jpg', ans: '4', text: 'Very Pleasant' },
        { stim: 'img/practice4.jpg', ans: '2', text: 'Unpleasant' }
    ];

    practice_stimuli.forEach((item, index) => {
        var p = {
            type: jsPsychCategorizeHtml,
            stimulus: `<img src="${item.stim}" style="height:400px;">`,
            choices: ['1', '2', '3', '4'],
            key_answer: item.ans,
            text_answer: item.text,
            correct_text: `<p class='prompt'>Correct!</p>`,
            incorrect_text: `<p class='prompt'>Incorrect. Please press ${item.ans} for ${item.text}.</p>`,
            prompt: `<p>Practice ${index + 1}: Rate this as <strong>${item.text}</strong>.</p>`,
            force_correct_button_press: true,
            data: { task: 'practice' }
        };
        timeline.push(p);
    });

    var questions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Questions? Signal the examiner. If ready, press any button to begin.</p>"
    };
    timeline.push(questions);

    /* MRI Sync */
    var MRIstart = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Please wait while the scanner starts up...</p>",
        choices: ['5'],
        prompt: "<p>Waiting for '5' pulse from scanner.</p>",
        data: { task: 'mri_trigger' }
    };
    timeline.push(MRIstart);

    var fixation_start = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: "NO_KEYS",
        trial_duration: 15000,
        data: { task: 'fixation_start' }
    };
    timeline.push(fixation_start);

    /* Main Task */
    var test_stimulus = [
        {stimulus: 'socialthreat/NS_NT1.jpg'},
        {stimulus: 'socialthreat/NS_NT2.jpg'},
        {stimulus: 'socialthreat/NS_NT3.jpg'},
        {stimulus: 'socialthreat/NS_NT4.jpg'},
        {stimulus: 'socialthreat/NS_NT5.jpg'},
        {stimulus: 'socialthreat/NS_NT6.jpg'},
        {stimulus: 'socialthreat/NS_NT7.jpg'},

        {stimulus: 'socialthreat/NS_T1.jpg'},
        {stimulus: 'socialthreat/NS_T2.jpg'},
        {stimulus: 'socialthreat/NS_T3.jpg'},
        {stimulus: 'socialthreat/NS_T4.jpg'},
        {stimulus: 'socialthreat/NS_T5.jpg'},
        {stimulus: 'socialthreat/NS_T6.jpg'},
        {stimulus: 'socialthreat/NS_T7.jpg'},

        {stimulus: 'socialthreat/S_NT1.jpg'},
        {stimulus: 'socialthreat/S_NT2_.jpg'},
        {stimulus: 'socialthreat/S_NT3_.jpg'},
        {stimulus: 'socialthreat/S_NT4_.jpg'},
        {stimulus: 'socialthreat/S_NT5_.jpg'},
        {stimulus: 'socialthreat/S_NT6_.jpg'},
        {stimulus: 'socialthreat/S_NT7_.jpg'},
        
        {stimulus: 'socialthreat/S_T1.jpg'},
        {stimulus: 'socialthreat/S_T2.jpg'},
        {stimulus: 'socialthreat/S_T3_.jpg'},
        {stimulus: 'socialthreat/S_T4_.jpg'},
        {stimulus: 'socialthreat/S_T5_.jpg'},
        {stimulus: 'socialthreat/S_T6_.jpg'},
        {stimulus: 'socialthreat/S_T7_.jpg'},

        {stimulus: 'socialthreat/NS_T1.jpg'},
        {stimulus: 'socialthreat/NS_T2.jpg'},
        {stimulus: 'socialthreat/NS_T3.jpg'},
        {stimulus: 'socialthreat/NS_T4.jpg'},
        {stimulus: 'socialthreat/NS_T5.jpg'},
        {stimulus: 'socialthreat/NS_T6.jpg'},
        {stimulus: 'socialthreat/NS_T7.jpg'},

       {stimulus: 'socialthreat/NS_NT1.jpg'},
        {stimulus: 'socialthreat/NS_NT2.jpg'},
        {stimulus: 'socialthreat/NS_NT3.jpg'},
        {stimulus: 'socialthreat/NS_NT4.jpg'},
        {stimulus: 'socialthreat/NS_NT5.jpg'},
        {stimulus: 'socialthreat/NS_NT6.jpg'},
        {stimulus: 'socialthreat/NS_NT7.jpg'},

      {stimulus: 'socialthreat/S_T1.jpg'},
        {stimulus: 'socialthreat/S_T2.jpg'},
        {stimulus: 'socialthreat/S_T3_.jpg'},
        {stimulus: 'socialthreat/S_T4_.jpg'},
        {stimulus: 'socialthreat/S_T5_.jpg'},
        {stimulus: 'socialthreat/S_T6_.jpg'},
        {stimulus: 'socialthreat/S_T7_.jpg'},

       {stimulus: 'socialthreat/S_NT1.jpg'},
        {stimulus: 'socialthreat/S_NT2_.jpg'},
        {stimulus: 'socialthreat/S_NT3_.jpg'},
        {stimulus: 'socialthreat/S_NT4_.jpg'},
        {stimulus: 'socialthreat/S_NT5_.jpg'},
        {stimulus: 'socialthreat/S_NT6_.jpg'},
        {stimulus: 'socialthreat/S_NT7_.jpg'},
    ];

    var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: "NO_KEYS",
        trial_duration: 600,
        data: { task: 'fixation' }
    };

    var test = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
        choices: "NO_KEYS",
        trial_duration: 750,
        stimulus_height: 650,
        maintain_aspect_ratio: true,
        data: { task: 'image_display' }
    };

    var response = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>How pleasant or unpleasant is this image?</p>",
        choices: ['1', '2', '3', '4'],
        trial_duration: 1500,
        data: { 
            task: 'response',
            image: jsPsych.timelineVariable('stimulus') // Attach image info to response data
        }
    };

    var test_procedure = {
        timeline: [fixation, test, response],
        timeline_variables: test_stimulus,
        randomize_order: false,
        post_trial_gap: 250
    };
    timeline.push(test_procedure);

    var fixation_end = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: "NO_KEYS",
        trial_duration: 15000,
        data: { task: 'fixation_end' }
    };
    timeline.push(fixation_end);

    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            var trials = jsPsych.data.get().filter({task: 'response'});
            var rt = Math.round(trials.select('rt').mean());
            return `<p>Your average response time was ${rt}ms.</p><p>Press any key to finish.</p>`;
        }
    };
    timeline.push(debrief_block);

    jsPsych.run(timeline);
</script>
</html>
